<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

 <mapper namespace="member">
	<resultMap type="com.netMiner.app.model.vo.MemberVo" id="MemberVo">
 		<id property="userId" column="USER_ID"/>
 		<result property="userPwd" column="USER_PWD"/>
 		<result property="company" column="COMPANY"/>
 		<result property="nation" column="NATION"/>
 		<result property="useCode" column="USE_CODE"/>
 		<result property="language" column = "LANGUAGE"/>
 		<result property="marketYn" column="MARKET_YN"/>
 	</resultMap> 
 	<select id="selectDate" resultType="String">
 	select now();
 	</select>
 
 	<select id="getUserInfo" resultMap="MemberVo" parameterType="MemberVo">
 	SELECT USER_ID, USER_PWD, COMPANY, NATION, `LANGUAGE`, USE_CODE, MARKET_YN
	FROM NetMiner.MEMBER_INFO
	WHERE USER_ID =  #{userId}
	AND USER_PWD  = password(#{userPwd});
 	</select>
 	
 	<insert id="insertSignUp" parameterType="MemberVo">
 	INSERT INTO NetMiner.MEMBER_INFO
	( USER_ID, USER_PWD, COMPANY, NATION, USE_CODE, LANGUAGE ,MARKET_YN ,MARKET_DATE, LAST_LOGIN_DATE, REG_DATE)
	VALUES( 
	#{userId} , PASSWORD(#{userPwd}) , #{company}, 
	#{nation}  , #{useCode} , #{language} ,#{marketYn} , now(), now(), now()
	);
	
 	</insert>
	<delete id="deleteMemberInfoTmp">
	DELETE FROM NetMiner.MEMBER_INFO_TEMP WHERE USER_ID = #{userId};
 	</delete>
 	
 	<update id="updateAuthkey" parameterType="MemberVo">
 	UPDATE NetMiner.MEMBER_INFO
 	SET AUTHKEY = #{authKey}
 	WHERE USER_ID = #{userId};
 	</update>
 	
 	
 	<insert id="insertMemberInfoTmp" parameterType="MemberVo">
 	INSERT INTO NetMiner.MEMBER_INFO_TEMP
	( USER_ID, USER_PWD, COMPANY, NATION, USE_CODE, LANGUAGE )
	VALUES( 
	#{userId} , PASSWORD(#{userPwd}) , #{company}, #{nation}  , #{useCode} , #{language} 
	);
 	</insert>
 	
 	<select id="getUserInfoTmp" resultMap="MemberVo" parameterType="MemberVo">
 	select * from NetMiner.MEMBER_INFO_TEMP
 	where USER_ID = #{userId};
 	</select>
 	
 	<insert id="signUpGeneral" parameterType="MemberVo">
 	INSERT INTO NetMiner.MEMBER_INFO
	( USER_ID, USER_PWD, COMPANY, NATION, USE_CODE, LANGUAGE ,MARKET_YN ,MARKET_DATE, LAST_LOGIN_DATE, REG_DATE)
	SELECT USER_ID, USER_PWD, COMPANY, NATION, USE_CODE, `LANGUAGE` ,#{marketYn} AS MARKET_YN , NOW() AS MARKET_DATE, NOW() AS LAST_LOGIN_DATE, NOW() AS LAST_LOGIN_DATE  
	FROM NetMiner.MEMBER_INFO_TEMP WHERE USER_ID = #{userId} LIMIT 1
 	;
 	</insert>
 	
 	<update id="updateLastLoginDate" parameterType="MemberVo">
 	UPDATE NetMiner.MEMBER_INFO 
 	SET LAST_LOGIN_DATE = NOW() 
 	WHERE USER_ID = #{userId}
	and USER_PWD  = password(#{userPwd}); 
 	</update>
 	
 	<select id="selectJoin" resultMap="MemberVo" parameterType="MemberVo">
 	select * from NetMiner.MEMBER_INFO mi 
	where mi.USER_ID = #{userId};
 	</select>
 	
 	<update id="updateNewPwd" parameterType="MemberVo">
 	UPDATE NetMiner.MEMBER_INFO
 	SET USER_PWD = password(#{userPwd})
 	WHERE USER_ID = #{userId}; 	
 	</update>
 	
 	<update id="updateUserId" parameterType="Map">
 	UPDATE NetMiner.MEMBER_INFO
 	SET USER_ID = #{newUserId}
 	WHERE USER_ID = #{userId}; 	
 	</update>
 	
 	<update id="updateUserInfo" parameterType="Map">
 	UPDATE netminer.member_info
	SET USER_ID = #{userId},
	 USER_PWD = password(#{userPwd}),
	 COMPANY = #{company},
	 NATION = #{nation},
	 `LANGUAGE` = #{language},
	 USE_CODE = #{useCode},
	 MARKET_YN = #{marketYn}
	WHERE  USER_ID = #{oldUserId};
 	</update>
 	<delete id="deleteTempUser">
 	<![CDATA[
	DELETE FROM NetMiner.MEMBER_INFO_TEMP WHERE REG_DTTM <= DATE_ADD(NOW() , INTERVAL -30 MINUTE);
 	]]>
 	</delete>
 </mapper>