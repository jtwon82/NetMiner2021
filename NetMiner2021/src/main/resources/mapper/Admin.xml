<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">

	<select id="selectDate" resultType="String">
		select now();
	</select>
	
	<sql id="listPagedWhere">
		WHERE 1=1
		<if test="SEARCH_KEY!=null and !SEARCH_KEY.equals('')">
			AND ${SEARCH_KEY} LIKE '%${SEARCH_VALUE}%'
		</if>
		<if test="USE_CODE!=null and !USE_CODE.equals('')">
			AND USE_CODE = #{USE_CODE}
		</if>
		<if test="LANGUAGE!=null and !LANGUAGE.equals('')">
			AND LANGUAGE = #{LANGUAGE}
		</if>
		<if test="MARKET_YN!=null and !MARKET_YN.equals('')">
			AND MARKET_YN = #{MARKET_YN}
		</if>
		<if test="SDATE!=null and !SDATE.equals('')">
			AND REG_DATE &gt;= #{SDATE}
		</if>
		<if test="EDATE!=null and !EDATE.equals('')">
			AND REG_DATE &lt;= #{EDATE}
		</if>
		
		<if test="USER_CODE_STATS!=null and USER_CODE_STATS=='QUIT' ">
			AND USER_CODE = '03'
			AND USER_STATS_YN = 'Y'
		</if>
		<if test="USER_CODE_STATS!=null and USER_CODE_STATS=='REST'">
			AND USER_CODE = '03'
			AND USER_STATS_YN = 'N'
		</if>
	</sql>
	<sql id="listPagedWhere2">
		WHERE 1=1
		<if test="_parameter.containsKey('firstOffset')">
			AND NO.rownum BETWEEN #{firstOffset} AND #{lastOffset}
		</if>
	</sql>
	<sql id="listPagedWhere3">
		WHERE 1=1
		<if test="_parameter.containsKey('page')">
			AND page= ${page}
		</if>
	</sql>




	<select id="getAdminCount" parameterType="map" resultType="int">
		/* getAdminCount */
		SELECT * FROM (
			SELECT COUNT(1)totcnt, 1 rownum
			FROM NetMiner.ADMIN_INFO A
			<include refid="listPagedWhere"/>
		) NO
	</select>
	
	<select id="getAdminList" parameterType="map" resultType="map">
		/* getAdminList */
		SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
				, ROW_NUMBER() OVER (ORDER BY NO DESC) AS rownum
			FROM NetMiner.ADMIN_INFO A
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	
	<select id="getAdminInfo" parameterType="map" resultType="map">
		/* getAdminInfo */
		SELECT A.*
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
			<if test="ADMIN_PWD!=''">, password(#{pwd}) pwd</if>
		FROM NetMiner.ADMIN_INFO A
		WHERE 1=1
			AND ADMIN_ID = #{ADMIN_ID}
			<if test="NO!=null and !NO.equals('')">AND NO = #{NO}</if>
	</select>
	
	<update id="modifyAdminInfo" parameterType="map">
		/* modifyAdminInfo */
		UPDATE NetMiner.ADMIN_INFO
			SET UPDATE_DATE = NOW()
			<if test="DESCRIPTION!=null and !DESCRIPTION.equals('')">, DESCRIPTION = #{DESCRIPTION}</if>
			<if test="ADMIN_PWD!=null and !ADMIN_PWD.equals('')">, ADMIN_PWD = password(#{ADMIN_PWD})</if>
			WHERE NO=#{NO}
	</update>
	
	<update id="insertAdminInfo" parameterType="map">
		/* insertAdminInfo */
		INSERT INTO NetMiner.ADMIN_INFO(ADMIN_CODE, ADMIN_ID, ADMIN_PWD, DESCRIPTION, REG_DATE)
			SELECT '01' ADMIN_CODE, #{ADMIN_ID} ADMIN_ID, password(#{ADMIN_PWD}) ADMIN_PWD, #{DESCRIPTION} DESCRIPTION, now() REG_DATE
	</update>
	
	<delete id="deleteAdminInfo" parameterType="map">
		/* deleteAdminInfo */
		DELETE FROM NetMiner.ADMIN_INFO
			WHERE NO=#{NO}
	</delete>




	<select id="getMemberCount" parameterType="map" resultType="int">
		/* getMemberCount */
		SELECT * FROM (
			SELECT COUNT(1)totcnt, 1 rownum
			FROM NetMiner.MEMBER_INFO A
			<include refid="listPagedWhere"/>
			AND USER_CODE='02'
		) NO
	</select>
	
	<select id="getMemberList" parameterType="map" resultType="map">
		/* getMemberList */
		SELECT * FROM (
			SELECT A.*
				, CASE WHEN USE_CODE='01' THEN 'Academic'
					WHEN USE_CODE='02' THEN 'Commercial' END USE_CODE_STR
				, DATE_FORMAT(A.REG_DATE,'%Y-%m-%d')REG_DATES
				, ROW_NUMBER() OVER (ORDER BY NO DESC) AS rownum
				, B.NATION_NAME_KR AS NATION_NAME_KR
			FROM NetMiner.MEMBER_INFO A
			INNER JOIN NATION_CODE B ON A.NATION = B.NATION_CODE 
			<include refid="listPagedWhere"/>
			AND USER_CODE='02'
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	
	<select id="getMemberInfo" parameterType="map" resultType="map">
		/* getMemberInfo */
		SELECT A.*
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d %H:%i:%s')REG_DATES
			, DATE_FORMAT(MARKET_DATE,'%Y-%m-%d %H:%i:%s')MARKET_DATES
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d %H:%i:%s')REG_DATES
			, DATE_FORMAT(LAST_LOGIN_DATE,'%Y-%m-%d')LAST_LOGIN_DATES
			<if test="pwd!=''">, password(#{pwd}) pwd</if>
		FROM NetMiner.MEMBER_INFO A
		WHERE 1=1
			<if test="NO!=null and !NO.equals('')">AND NO = #{NO}</if>
	</select>
	
	<update id="modifyMemberInfo" parameterType="map">
		/* modifyMemberInfo */
		UPDATE NetMiner.MEMBER_INFO
			SET UPDATE_DATE = NOW()
			<if test="USER_CODE!=null and !USER_CODE.equals('')">, USER_CODE= #{USER_CODE}</if>
			<if test="USE_CODE!=null and !USE_CODE.equals('')">, USE_CODE= #{USE_CODE}</if>
			<if test="USER_ID!=null and !USER_ID.equals('')">, USER_ID= #{USER_ID}</if>
			<if test="USER_PWD!=null and !USER_PWD.equals('')">, USER_PWD= PASSWORD(#{USER_PWD})</if>
			<if test="LANGUAGE!=null and !LANGUAGE.equals('')">, LANGUAGE= #{LANGUAGE}</if>
			<if test="NATION!=null and !NATION.equals('')">, NATION= #{NATION}</if>
			<if test="COMPANY!=null and !COMPANY.equals('')">, COMPANY= #{COMPANY}</if>
			<if test="MARKET_YN!=null and !MARKET_YN.equals('')">, MARKET_YN= #{MARKET_YN}</if>
			<if test="MARKET_YN.equals('Y') and MARKET_YN!=null and !MARKET_YN.equals('')">, MARKET_DATE = now()</if>
			WHERE NO=#{NO}
	</update>
		<update id="modifyDropMemberInfo" parameterType="map">
		/* modifyMemberInfo */
		UPDATE NetMiner.MEMBER_INFO_DROP
			SET UPDATE_DATE = NOW()
			<if test="USER_CODE!=null and !USER_CODE.equals('')">, USER_CODE= #{USER_CODE}</if>
			<if test="USE_CODE!=null and !USE_CODE.equals('')">, USE_CODE= #{USE_CODE}</if>
			<if test="USER_ID!=null and !USER_ID.equals('')">, USER_ID= #{USER_ID}</if>
			<if test="USER_PWD!=null and !USER_PWD.equals('')">, USER_PWD= PASSWORD(#{USER_PWD})</if>
			<if test="LANGUAGE!=null and !LANGUAGE.equals('')">, LANGUAGE= #{LANGUAGE}</if>
			<if test="NATION!=null and !NATION.equals('')">, NATION= #{NATION}</if>
			<if test="COMPANY!=null and !COMPANY.equals('')">, COMPANY= #{COMPANY}</if>
			<if test="MARKET_YN!=null and !MARKET_YN.equals('')">, MARKET_YN= #{MARKET_YN} </if>
			<if test="MARKET_YN.equals('Y') and MARKET_YN!=null and !MARKET_YN.equals('')">, MARKET_DATE = now()</if>
			WHERE NO=#{NO}
	</update>
	<update id="insertMemberInfo" parameterType="map">
		/* insertMemberInfo */
		INSERT INTO NetMiner.MEMBER_INFO(USER_CODE, USER_ID, USER_PWD
				, COMPANY, NATION, LANGUAGE, USE_CODE
				, MARKET_YN, MARKET_DATE, REG_DATE)
				
			SELECT '02' USER_CODE, #{USER_ID} USER_ID, password(#{USER_PWD}) USER_PWD
				, #{COMPANY} COMPANY, #{NATION} NATION, #{LANGUAGE} LANGUAGE, #{USE_CODE} USE_CODE
				, #{MARKET_YN} MARKET_YN, NOW() MARKET_DATE, NOW() REG_DATE
	</update>
	
	<insert id="insertMemberInfoDrop" parameterType="map">
	INSERT INTO NetMiner.MEMBER_INFO_DROP(USER_CODE, USER_ID, USER_PWD
				, COMPANY, NATION, LANGUAGE, USE_CODE
				, MARKET_YN, MARKET_DATE, REG_DATE, LAST_LOGIN_DATE , USER_OUT_DATE, USER_STATS_YN)
		SELECT '03' AS USER_CODE , USER_ID ,USER_PWD ,COMPANY,NATION,LANGUAGE, USE_CODE
				, MARKET_YN, MARKET_DATE, REG_DATE, LAST_LOGIN_DATE, NOW() USER_OUT_DATE ,'Y' AS USER_STATS_YN
				FROM NetMiner.MEMBER_INFO
				WHERE NO = #{NO};
	DELETE FROM NetMiner.MEMBER_INFO
			WHERE NO=#{NO};			
	</insert>
	

	<sql id="getMemberQuit">
		SELECT A.*, B.NATION_NAME_KR FROM NetMiner.MEMBER_INFO_DROP A
		INNER JOIN NetMiner.NATION_CODE  B ON A.NATION = B.NATION_CODE 
			WHERE USER_CODE='03' OR LAST_LOGIN_DATE &lt; DATE_ADD(NOW(), INTERVAL -365 DAY)
	</sql>
	<select id="getMemberQuitCount" parameterType="map" resultType="int">
		/* getMemberQuitCount */
		SELECT * FROM (
			SELECT COUNT(1)totcnt, 1 rownum
			FROM ( <include refid="getMemberQuit"/> ) A
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	
	<select id="getMemberQuitList" parameterType="map" resultType="map">
		/* getMemberQuitList */
		SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
				, ROW_NUMBER() OVER (ORDER BY NO DESC) AS rownum
				, @RNUM:=@RNUM+1 as ROWNUM2, CEIL(@RNUM / 3) as page
			FROM ( <include refid="getMemberQuit"/> ) AS A, (SELECT @RNUM:=0) R			
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere3"/>
	</select>
	
	<select id="getMemberQuitInfo" parameterType="map" resultType="map">
		/* getMemberQuitInfo */
		SELECT A.*
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d %H:%i:%s')REG_DATES
			, DATE_FORMAT(MARKET_DATE,'%Y-%m-%d %H:%i:%s')MARKET_DATES
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d %H:%i:%s')REG_DATES
			, DATE_FORMAT(LAST_LOGIN_DATE,'%Y-%m-%d %H:%i:%s')LAST_LOGIN_DATES
			, DATE_FORMAT(USER_OUT_DATE,'%Y-%m-%d %H:%i:%s')USER_OUT_DATES
			<if test="pwd!=''">, password(#{pwd}) pwd</if>
		FROM NetMiner.MEMBER_INFO_DROP A
		WHERE 1=1
			<if test="NO!=null and !NO.equals('')">AND NO = #{NO}</if>
	</select>
 	
	<update id="modifyMemberQuitInfo" parameterType="map">
		/* modifyMemberQuitInfo */
		UPDATE NetMiner.MEMBER_INFO_DROP
			SET UPDATE_DATE = NOW()
			<if test="USE_CODE!=null and !USE_CODE.equals('')">, USE_CODE= #{USE_CODE}</if>
			<if test="USER_ID!=null and !USER_ID.equals('')">, USER_ID= #{USER_ID}</if>
			<if test="USER_PWD!=null and !USER_PWD.equals('')">, USER_PWD= PASSWORD(#{USER_PWD})</if>
			<if test="LANGUAGE!=null and !LANGUAGE.equals('')">, LANGUAGE= #{LANGUAGE}</if>
			<if test="NATION!=null and !NATION.equals('')">, NATION= #{NATION}</if>
			<if test="COMPANY!=null and !COMPANY.equals('')">, COMPANY= #{COMPANY}</if>
			<if test="MARKET_YN!=null and !MARKET_YN.equals('')">, MARKET_YN= #{MARKET_YN}</if>
			<if test="MARKET_YN.equals('Y') and MARKET_YN!=null and !MARKET_YN.equals('')">, MARKET_DATE = now()</if>
			<if test="USER_STATS_YN!=null and !USER_STATS_YN.equals('')">, USER_STATS_YN= #{USER_STATS_YN}</if>
			WHERE NO=#{NO}
	</update> 
	
	<update id="recoverMemberQuitInfo" parameterType="map">
		/* insertMemberQuitInfo */
		INSERT INTO NetMiner.MEMBER_INFO(USER_CODE, USER_ID, USER_PWD
				, COMPANY, NATION, LANGUAGE, USE_CODE , LAST_LOGIN_DATE
				, MARKET_YN, MARKET_DATE, REG_DATE)
				
			SELECT '02' USER_CODE, USER_ID, USER_PWD
				, COMPANY, NATION, LANGUAGE, USE_CODE , NOW() LAST_LOGIN_DATE
				, MARKET_YN, NOW() MARKET_DATE, NOW() REG_DATE
				FROM NetMiner.MEMBER_INFO_DROP
				WHERE NO = #{NO};
			DELETE FROM NetMiner.MEMBER_INFO_DROP
			WHERE NO = #{NO};
	</update> 
	
	<delete id="deleteMemberQuitInfo" parameterType="map">
		/* deleteMemberQuitInfo */
		DELETE FROM NetMiner.MEMBER_INFO_DROP
			WHERE NO=#{NO}
	</delete>
	
	<select id="getEmailList" parameterType="map" resultType="map">
		SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
				, ROW_NUMBER() OVER (ORDER BY NO DESC) AS rownum
			FROM NetMiner.EMAIL_INFO A
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	<select id="getEmailCount" parameterType="map" resultType="int">
	SELECT * FROM (
			SELECT COUNT(1)totcnt, 1 rownum
			FROM NetMiner.EMAIL_INFO A
			<include refid="listPagedWhere"/>
		) NO
	</select>
	<select id="getEmailDetailInfo" parameterType="map" resultType="map">
	SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
			FROM NetMiner.EMAIL_INFO A
	<if test="NO!=null and !NO.equals('')">WHERE A.NO = #{NO}</if>
		) NO
	</select>
	
	<delete id="delteEmailInfo" parameterType="map">
	DELETE FROM NetMiner.EMAIL_INFO
	WHERE `NO` = #{NO}
	</delete>
	<update id="insertEmailInfo"  parameterType="map">
	INSERT INTO NetMiner.EMAIL_INFO
	(EMAIL_CODE, TITLE, `EXPLAIN`, COMMENT, REG_DATE)
	SELECT 
	MAX(EMAIL_CODE)+1 AS EMAIL_CODE
	, #{TITLE} AS TITLE
	, #{EXPLAIN} AS `EXPLAIN`
	, #{COMMENT} AS COMMENT
	, NOW() AS REG_DATE
	FROM EMAIL_INFO;
	</update>
	<update id="modifyEmailInfo"  parameterType="map">
	UPDATE NetMiner.EMAIL_INFO 
		SET EMAIL_CODE = #{EMAIL_CODE}
		<if test="TITLE!=null and ! TITLE.equals('')">, TITLE = #{TITLE}</if> 
		<if test="COMMENT!=null and !COMMENT.equals('')">, COMMENT = #{COMMENT}</if> 
	WHERE `NO` = ${NO}
	
	</update>
	
	<select id="getCheck" resultType="Map">
	SELECT A.*, 
	 DATE_FORMAT(START_DATE,'%Y-%m-%d')START_DATES,
	 DATE_FORMAT(END_DATE,'%Y-%m-%d')END_DATES,
	 DATE_FORMAT(START_DATE, '%H')START_HH,
	 DATE_FORMAT(END_DATE , '%H') END_HH
	 FROM NetMiner.CHECK_START_END_TIME A
	WHERE NO = (SELECT MAX(NO) FROM NetMiner.CHECK_START_END_TIME)
	</select>
	
	<update id="modifyCheck" parameterType="map">
	INSERT INTO NetMiner.CHECK_START_END_TIME
	(START_DATE, END_DATE, COMMENT_KR, COMMENT_EN, STATS_YN, END_DATE_YN, REG_DATE)
	SELECT 
	STR_TO_DATE(CONCAT(#{START_DATE}, #{START_HH}),'%Y-%m-%d %H') AS START_DATE 
	<if test="END_DATE != null and ! END_DATE.equals('')">, STR_TO_DATE(CONCAT(#{END_DATE}, #{END_HH}),'%Y-%m-%d %H')  </if>
	<if test="END_DATE == null or END_DATE.equals('')">, NULL</if>AS END_DATE 
	, #{COMMENT_KR} AS COMMENT_KR
	, #{COMMENT_EN} AS COMMENT_EN
	, #{STATS_YN} AS STATS_YN
	<if test="END_DATE_YN != null and ! END_DATE_YN.equals('')">, 'Y'</if>
	<if test="END_DATE_YN == null or END_DATE_YN.equals('')">, 'N' </if> AS END_DATE_YN
	, NOW() AS REG_DATE;
	</update>
</mapper>