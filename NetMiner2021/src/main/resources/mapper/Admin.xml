<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">

	<select id="selectDate" resultType="String">
		select now();
	</select>
	
	<sql id="listPagedWhere">
		WHERE 1=1
		<if test="SEARCH_KEY!=null and !SEARCH_KEY.equals('')">
			AND ${SEARCH_KEY} LIKE '%${SEARCH_VALUE}%'
		</if>
		<if test="USE_CODE!=null and !USE_CODE.equals('')">
			AND USE_CODE = #{USE_CODE}
		</if>
		<if test="LANGUAGE!=null and !LANGUAGE.equals('')">
			AND LANGUAGE = #{LANGUAGE}
		</if>
		<if test="MARKET_YN!=null and !MARKET_YN.equals('')">
			AND MARKET_YN = #{MARKET_YN}
		</if>
		<if test="SDATE!=null and !SDATE.equals('')">
			AND REG_DATE &gt;= #{SDATE}
		</if>
		<if test="EDATE!=null and !EDATE.equals('')">
			AND REG_DATE &lt;= #{EDATE}
		</if>
		
		<if test="USER_CODE_STATS!=null and USER_CODE_STATS=='QUIT' ">
			AND USER_CODE = '03'
		</if>
		<if test="USER_CODE_STATS!=null and USER_CODE_STATS=='REST'">
			AND LAST_LOGIN_DATE &lt; DATE_ADD(NOW(), INTERVAL -365 DAY)
		</if>
	</sql>
	<sql id="listPagedWhere2">
		WHERE 1=1
		<if test="_parameter.containsKey('firstOffset')">
			AND NO.rownum BETWEEN #{firstOffset} AND #{lastOffset}
		</if>
	</sql>
	<sql id="listPagedWhere3">
		WHERE 1=1
		<if test="_parameter.containsKey('page')">
			AND page= ${page}
		</if>
	</sql>




	<select id="getAdminCount" parameterType="map" resultType="int">
		/* getAdminCount */
		SELECT * FROM (
			SELECT COUNT(1)totcnt, 1 rownum
			FROM NetMiner.ADMIN_INFO A
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	
	<select id="getAdminList" parameterType="map" resultType="map">
		/* getAdminList */
		SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
				, ROW_NUMBER() OVER (ORDER BY NO DESC) AS rownum
			FROM NetMiner.ADMIN_INFO A
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	
	<select id="getAdminInfo" parameterType="map" resultType="map">
		/* getAdminInfo */
		SELECT A.*
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
			<if test="ADMIN_PWD!=''">, password(#{pwd}) pwd</if>
		FROM NetMiner.ADMIN_INFO A
		WHERE 1=1
			<if test="ADMIN_ID!=null and !ADMIN_ID.equals('')">AND ADMIN_ID = #{ADMIN_ID}</if>
			<if test="NO!=null and !NO.equals('')">AND NO = #{NO}</if>
	</select>
	
	<update id="modifyAdminInfo" parameterType="map">
		/* modifyAdminInfo */
		UPDATE NetMiner.ADMIN_INFO
			SET UPDATE_DATE = NOW()
			<if test="DESCRIPTION!=null and !DESCRIPTION.equals('')">, DESCRIPTION = #{DESCRIPTION}</if>
			<if test="ADMIN_PWD!=null and !ADMIN_PWD.equals('')">, ADMIN_PWD = password(#{ADMIN_PWD})</if>
			WHERE NO=#{NO}
	</update>
	
	<update id="insertAdminInfo" parameterType="map">
		/* insertAdminInfo */
		INSERT INTO NetMiner.ADMIN_INFO(ADMIN_CODE, ADMIN_ID, ADMIN_PWD, DESCRIPTION, REG_DATE)
			SELECT '01' ADMIN_CODE, #{ADMIN_ID} ADMIN_ID, password(#{ADMIN_PWD}) ADMIN_PWD, #{DESCRIPTION} DESCRIPTION, now() REG_DATE
	</update>
	
	<delete id="deleteAdminInfo" parameterType="map">
		/* deleteAdminInfo */
		DELETE FROM NetMiner.ADMIN_INFO
			WHERE NO=#{NO}
	</delete>




	<select id="getMemberCount" parameterType="map" resultType="int">
		/* getMemberCount */
		SELECT * FROM (
			SELECT COUNT(1)totcnt, 1 rownum
			FROM NetMiner.MEMBER_INFO A
			<include refid="listPagedWhere"/>
			AND USER_CODE='02'
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	
	<select id="getMemberList" parameterType="map" resultType="map">
		/* getMemberList */
		SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
				, ROW_NUMBER() OVER (ORDER BY NO DESC) AS rownum
			FROM NetMiner.MEMBER_INFO A
			<include refid="listPagedWhere"/>
			AND USER_CODE='02'
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	
	<select id="getMemberInfo" parameterType="map" resultType="map">
		/* getMemberInfo */
		SELECT A.*
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
			, DATE_FORMAT(MARKET_DATE,'%Y-%m-%d')MARKET_DATES
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
			<if test="pwd!=''">, password(#{pwd}) pwd</if>
		FROM NetMiner.MEMBER_INFO A
		WHERE 1=1
			<if test="NO!=null and !NO.equals('')">AND NO = #{NO}</if>
	</select>
	
	<update id="modifyMemberInfo" parameterType="map">
		/* modifyMemberInfo */
		UPDATE NetMiner.MEMBER_INFO
			SET UPDATE_DATE = NOW()
			<if test="USER_CODE!=null and !USER_CODE.equals('')">, USER_CODE= #{USER_CODE}</if>
			<if test="USE_CODE!=null and !USE_CODE.equals('')">, USE_CODE= #{USE_CODE}</if>
			<if test="USER_ID!=null and !USER_ID.equals('')">, USER_ID= #{USER_ID}</if>
			<if test="USER_PWD!=null and !USER_PWD.equals('')">, USER_PWD= PASSWORD(#{USER_PWD})</if>
			<if test="LANGUAGE!=null and !LANGUAGE.equals('')">, LANGUAGE= #{LANGUAGE}</if>
			<if test="NATION!=null and !NATION.equals('')">, NATION= #{NATION}</if>
			<if test="COMPANY!=null and !COMPANY.equals('')">, COMPANY= #{COMPANY}</if>
			<if test="MARKET_YN!=null and !MARKET_YN.equals('')">, MARKET_YN= #{MARKET_YN}</if>
			WHERE NO=#{NO}
	</update>
	
	<update id="insertMemberInfo" parameterType="map">
		/* insertMemberInfo */
		INSERT INTO NetMiner.MEMBER_INFO(USER_CODE, USER_ID, USER_PWD
				, COMPANY, NATION, LANGUAGE, USE_CODE
				, MARKET_YN, MARKET_DATE, REG_DATE)
				
			SELECT '02' USER_CODE, #{USER_ID} USER_ID, password(#{USER_PWD}) USER_PWD
				, #{COMPANY} COMPANY, #{NATION} NATION, #{LANGUAGE} LANGUAGE, #{USE_CODE} USE_CODE
				, #{MARKET_YN} MARKET_YN, NOW() MARKET_DATE, NOW() REG_DATE
	</update>
	
	<delete id="deleteMemberInfo" parameterType="map">
		/* deleteMemberInfo */
		DELETE FROM NetMiner.MEMBER_INFO
			WHERE NO=#{NO}
	</delete>




	<sql id="getMemberQuit">
		SELECT * FROM NetMiner.MEMBER_INFO 
			WHERE USER_CODE='03' OR LAST_LOGIN_DATE &lt; DATE_ADD(NOW(), INTERVAL -365 DAY)
	</sql>
	<select id="getMemberQuitCount" parameterType="map" resultType="int">
		/* getMemberQuitCount */
		SELECT * FROM (
			SELECT COUNT(1)totcnt, 1 rownum
			FROM ( <include refid="getMemberQuit"/> ) A
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	
	<select id="getMemberQuitList" parameterType="map" resultType="map">
		/* getMemberQuitList */
		SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
				, ROW_NUMBER() OVER (ORDER BY NO DESC) AS rownum
				, @RNUM:=@RNUM+1 as ROWNUM2, CEIL(@RNUM / 3) as page
			FROM ( <include refid="getMemberQuit"/> ) A, (SELECT @RNUM:=0) R
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere3"/>
	</select>
	
	<select id="getMemberQuitInfo" parameterType="map" resultType="map">
		/* getMemberQuitInfo */
		SELECT A.*
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
			, DATE_FORMAT(MARKET_DATE,'%Y-%m-%d')MARKET_DATES
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
			<if test="pwd!=''">, password(#{pwd}) pwd</if>
		FROM NetMiner.MEMBER_INFO A
		WHERE 1=1
			<if test="NO!=null and !NO.equals('')">AND NO = #{NO}</if>
	</select>
	
	<update id="modifyMemberQuitInfo" parameterType="map">
		/* modifyMemberQuitInfo */
		UPDATE NetMiner.MEMBER_INFO
			SET UPDATE_DATE = NOW()
			<if test="USE_CODE!=null and !USE_CODE.equals('')">, USE_CODE= #{USE_CODE}</if>
			<if test="USER_ID!=null and !USER_ID.equals('')">, USER_ID= #{USER_ID}</if>
			<if test="USER_PWD!=null and !USER_PWD.equals('')">, USER_PWD= PASSWORD(#{USER_PWD})</if>
			<if test="LANGUAGE!=null and !LANGUAGE.equals('')">, LANGUAGE= #{LANGUAGE}</if>
			<if test="NATION!=null and !NATION.equals('')">, NATION= #{NATION}</if>
			<if test="COMPANY!=null and !COMPANY.equals('')">, COMPANY= #{COMPANY}</if>
			<if test="MARKET_YN!=null and !MARKET_YN.equals('')">, MARKET_YN= #{MARKET_YN}</if>
			WHERE NO=#{NO}
	</update>
	
	<update id="insertMemberQuitInfo" parameterType="map">
		/* insertMemberQuitInfo */
		INSERT INTO NetMiner.MEMBER_INFO(USER_CODE, USER_ID, USER_PWD
				, COMPANY, NATION, LANGUAGE, USE_CODE
				, MARKET_YN, MARKET_DATE, REG_DATE)
				
			SELECT '02' USER_CODE, #{USER_ID} USER_ID, password(#{USER_PWD}) USER_PWD
				, #{COMPANY} COMPANY, #{NATION} NATION, #{LANGUAGE} LANGUAGE, #{USE_CODE} USE_CODE
				, #{MARKET_YN} MARKET_YN, NOW() MARKET_DATE, NOW() REG_DATE
	</update>
	
	<delete id="deleteMemberQuitInfo" parameterType="map">
		/* deleteMemberQuitInfo */
		DELETE FROM NetMiner.MEMBER_INFO
			WHERE NO=#{NO}
	</delete>
	
	<select id="getEmailList" parameterType="map" resultType="map">
		SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
				, ROW_NUMBER() OVER (ORDER BY NO DESC) AS rownum
			FROM NetMiner.EMAIL_INFO A
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	<select id="getEmailCount" parameterType="map" resultType="int">
	SELECT * FROM (
			SELECT COUNT(1)totcnt, 1 rownum
			FROM NetMiner.EMAIL_INFO A
			<include refid="listPagedWhere"/>
		) NO
		<include refid="listPagedWhere2"/>
	</select>
	<select id="getEmailDetailInfo" parameterType="map" resultType="map">
	SELECT * FROM (
			SELECT A.*
				, DATE_FORMAT(REG_DATE,'%Y-%m-%d')REG_DATES
			FROM NetMiner.EMAIL_INFO A
	<if test="NO!=null and !NO.equals('')">WHERE A.NO = #{NO}</if>
		) NO
	</select>
	
	<delete id="delteEmailInfo" parameterType="map">
	DELETE FROM NetMiner.EMAIL_INFO
	WHERE `NO` = #{NO}
	</delete>
	<update id="insertEmailInfo"  parameterType="map">
	INSERT INTO NetMiner.EMAIL_INFO
	(EMAIL_CODE, TITLE, `EXPLAIN`, COMMENT, REG_DATE)
	SELECT 
	MAX(EMAIL_CODE)+1 AS EMAIL_CODE
	, #{TITLE} AS TITLE
	, #{EXPLAIN} AS `EXPLAIN`
	, #{COMMENT} AS COMMENT
	, NOW() AS REG_DATE
	FROM EMAIL_INFO;
	</update>
	<update id="modifyEmailInfo"  parameterType="map">
	UPDATE NetMiner.EMAIL_INFO 
		SET EMAIL_CODE = #{EMAIL_CODE}
		<if test="TITLE!=null and ! TITLE.equals('')">, TITLE = #{TITLE}</if> 
		<if test="COMMENT!=null and !COMMENT.equals('')">, COMMENT = #{COMMENT}</if> 
	WHERE `NO` = ${NO}
	
	</update>
</mapper>