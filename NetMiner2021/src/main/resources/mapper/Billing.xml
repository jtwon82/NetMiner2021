<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="billing">
	<select id="selectPlanCode" parameterType="Map" resultType="Map">
		select * from NetMiner.PLAN_CODE 
		WHERE PLAN_CODE= ${planCode}
	</select>
	
	<select id="selectSubscript" parameterType="Map" resultType="Map">
		select A.*, B.* 
		from NetMiner.SUBSCRIPT AS A 
		INNER JOIN NetMiner.PLAN_CODE  AS B ON A.PLAN_CODE = B.PLAN_CODE 
		where USER_ID =#{userId}
		order by no desc limit 1
	</select>
	
	<update id="insertSubscript" parameterType="BillingVo">
	INSERT INTO NetMiner.SUBSCRIPT (
		REG_DATE, USER_ID
		, PLAN_CODE, PLAN_TYPE, DATE_TYPE, PAY_TYPE
		, PAY_STEP , PAY_PLATFORM, PAY_PRICE, PAY_PRICE_TOTAL
		, ACCOUNT_NAME, ACCOUNT_NO, ACCOUNT_HOLDER, ACCOUNT_DEPOSITLIMIT
		, ORDER_ID, ORDER_PNM, paymentKey, amount, EXITS_DATE) 
	SELECT now(), #{USER_ID}
		, #{PLAN_CODE}, #{PLAN_TYPE}, #{DATE_TYPE}, #{PAY_TYPE}
		, #{PAY_STEP}, #{PAY_PLATFORM}, #{PAY_PRICE}, #{PAY_PRICE_TOTAL}
		, #{ACCOUNT_NAME}, #{ACCOUNT_NO}, #{ACCOUNT_HOLDER}, now()
		, #{ORDER_ID}, #{ORDER_PNM}, #{paymentKey}, #{amount},
			CASE WHEN #{DATE_TYPE} = 'month' 
			THEN DATE_FORMAT(DATE_ADD(now(), INTERVAL 1 MONTH), '%Y-%m-%d %H:%i:%S') 
			ELSE DATE_FORMAT(DATE_ADD(now(), INTERVAL 1 YEAR), '%Y-%m-%d %H:%i:%S')
			END AS EXITS_DATE
			;
	</update>
	
	<select id="selectSubscriptAll" parameterType="Map" resultType="Map">
		select A.*, B.* 
		 from NetMiner.SUBSCRIPT AS A 
		INNER JOIN NetMiner.PLAN_CODE  AS B ON A.PLAN_CODE = B.PLAN_CODE
		where USER_ID =#{userId}
		AND A.REG_DATE  <![CDATA[>=]]> DATE_ADD(NOW(), INTERVAL -3 MONTH)
		AND A.PLAN_CODE != '01'
		order by A.REG_DATE DESC;
	</select>
	
	<select id="selectSubscriptOne" parameterType="Map" resultType="Map">
		select DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') AS REG_DATE, A.USER_ID, A.PLAN_CODE, A.PLAN_TYPE, A.PAY_PLATFORM, A.PAY_STEP, A.PAY_TYPE, A.PAY_PRICE, A.PAY_PRICE_TOTAL,
				 A.ACCOUNT_NAME, A.ACCOUNT_NO, A.ACCOUNT_HOLDER, A.ACCOUNT_DEPOSITLIMIT, A.ORDER_ID, A.ORDER_PNM, A.paymentKey, A.amount 
			, B.* 
		 from NetMiner.SUBSCRIPT AS A 
		INNER JOIN NetMiner.PLAN_CODE  AS B ON A.PLAN_CODE = B.PLAN_CODE
		where A.NO =#{billingNo};
	</select>
</mapper>